<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Master (v15.2 - Immutable Login)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .btn { background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size:16px; transition: 0.2s;}
        .btn:hover { background: #1d4ed8; }
        .btn-outline { background: transparent; border: 2px solid #ddd; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: #555; }
        .btn-nav { width: 48%; display: inline-block; }
        .btn-sm { padding: 6px 12px; font-size: 13px; width: auto; margin-top: 5px; border-radius: 6px;}

        /* Progress Bars */
        .progress-container { background: #eee; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; position: relative; }
        .progress-fill { background: #2563eb; height: 100%; width: 0%; transition: 0.3s; }
        .timer-fill { background: orange; height: 100%; width: 100%; transition: 1s linear; }

        /* Training UI */
        .word-btn { background: #eff6ff; padding: 10px 15px; margin: 5px; border: 1px solid #bfdbfe; border-radius: 20px; cursor: pointer; display: inline-block; color: #2563eb; user-select: none; }
        .word-btn.used { opacity: 0.3; pointer-events: none; }
        input[type="text"] { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; margin-top: 10px; box-sizing: border-box; outline:none; }
        input[type="text"]:focus { border-color:#2563eb; }
        .feedback { text-align: center; font-weight: bold; margin: 15px 0; min-height: 25px; font-size: 1.1em; }
        
        /* Test Results */
        .result-row { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .res-correct { color: green; }
        .res-wrong { color: red; }
        .res-answer { font-weight: bold; display: block; margin-top: 3px; color:#555;}

        /* Modal Overlay */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; text-align: left; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top:0; color:#2563eb;}

        /* Nav & Grid */
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .nav-btn { flex: 1; padding: 12px; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666;}
        .nav-btn.active { background: #2563eb; color: white; }
        .grid-lessons { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .item-card { background: white; border: 2px solid #eee; padding: 15px 5px; text-align: center; border-radius: 8px; cursor: default; display:flex; flex-direction:column; justify-content:space-between;}
        .item-card.locked { background: #f9fafb; color: #aaa; border-color: #eee; }
        .item-card.completed { background: #ecfdf5; border-color: #10b981; }
        
        /* Vocab Item */
        .vocab-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .vocab-item.mastered { background: #f0fdf4; border-left: 4px solid #10b981; }

        /* Stats */
        .stats-bar { display: flex; justify-content: space-between; background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .stat-val { font-size: 1.2em; font-weight: bold; color: #2563eb; text-align:center; }
        .stat-lbl { font-size: 0.8em; color: #666; text-align:center; }
    </style>
</head>
<body>

    <div id="screen-login" class="container" style="text-align: center; margin-top: 100px;">
        <h1 style="color: #2563eb;">üá¨üáß English Master</h1>
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <p>Prihl√°s sa a pokraƒçuj v uƒçen√≠</p>
            <button id="btn-login-google" class="btn">Prihl√°si≈• sa cez Google</button>
            <div id="login-log" style="color: red; margin-top: 15px; font-size: 13px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="screen-dashboard" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="font-weight:bold; font-size:1.1em;">üë§ <span id="user-nick">...</span> <button id="btn-change-nick" style="border:none;background:none;cursor:pointer;font-size:0.9em;">‚úèÔ∏è</button></div>
            <button id="btn-logout" class="btn-outline" style="color:red; border-color:red; padding:6px 12px;">Odhl√°si≈•</button>
        </div>

        <div class="stats-bar">
            <div><div class="stat-val" id="disp-points">0</div><div class="stat-lbl">Body</div></div>
            <div><div class="stat-val" id="disp-time">0m</div><div class="stat-lbl">Dnes</div></div>
            <div><div class="stat-val" id="disp-vocab">0</div><div class="stat-lbl">Nauƒçen√©</div></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-btn active" id="tab-btn-lessons">Lekcie</button>
            <button class="nav-btn" id="tab-btn-vocab">Slovn√≠k</button>
            <button class="nav-btn" id="tab-btn-leaderboard">Rebr√≠ƒçek</button>
        </div>

        <div id="view-lessons">
            <div id="level-select" class="card">
                <h3>Vyber √∫rove≈à:</h3>
                <div class="grid-lessons" id="grid-levels"></div>
            </div>
            <div id="lesson-select" class="card hidden">
                <button id="btn-back-levels" class="btn-outline" style="margin-bottom:15px;">‚¨Ö Sp√§≈• na √∫rovne</button>
                <h3 id="current-level-title" style="margin-top:0;">...</h3>
                <div class="grid-lessons" id="grid-lessons-list"></div>
            </div>
            <div id="chapter-select" class="card hidden">
                <button id="btn-back-lessons" class="btn-outline" style="margin-bottom:15px;">‚¨Ö Sp√§≈• na lekcie</button>
                <h3 id="current-lesson-title" style="margin-top:0;">...</h3>
                <div class="grid-lessons" id="grid-chapters"></div>
            </div>
        </div>

        <div id="view-vocab" class="hidden">
            <div class="card" style="text-align:center;">
                <h3 style="margin-top:0;">Inteligentn√Ω Slovn√≠k</h3>
                <p style="font-size:14px; color:#555;">Slovo sa oznaƒç√≠ ako "Nauƒçen√©" a≈æ keƒè ho zodpovie≈° 3x spr√°vne do angliƒçtiny a 3x do slovenƒçiny.</p>
                <button id="btn-start-vocab" class="btn" style="background:orange;">‚ö° Tr√©nova≈• slov√≠ƒçka</button>
            </div>
            
            <div class="nav-tabs" style="margin-bottom: 10px;">
                <button class="nav-btn active" id="btn-voc-learning">Uƒç√≠m sa (0)</button>
                <button class="nav-btn" id="btn-voc-learned">Nauƒçen√© (0)</button>
            </div>
            
            <div id="vocab-list-learning" class="card"></div>
            <div id="vocab-list-learned" class="card hidden"></div>
        </div>

        <div id="view-leaderboard" class="hidden">
            <div class="card" id="leaderboard-list">Naƒç√≠tavam...</div>
        </div>
    </div>

    <div id="screen-training" class="container hidden">
        <button id="btn-quit-training" class="btn-outline">‚ùå Ukonƒçi≈•</button>
        
        <div class="card">
            <div style="display:flex; justify-content:space-between; color:#666; font-size:12px; margin-bottom:5px;">
                <span id="train-info-round" style="font-weight:bold; color:#2563eb;">...</span>
                <span id="train-counter">0/10</span>
            </div>

            <div class="progress-container" id="bar-progress-container">
                <div id="bar-progress" class="progress-fill"></div>
            </div>
            <div class="progress-container hidden" id="bar-timer-container" style="background:#ddd;">
                <div id="bar-timer" class="timer-fill"></div>
            </div>

            <div id="train-grammar" style="background:#fff9db; padding:15px; border-left:5px solid orange; margin-bottom:20px; display:none; font-size:14px;"></div>

            <div style="text-align:center;">
                <h2 id="train-question">...</h2>
                <button id="btn-speak" style="font-size:24px; border:none; background:orange; border-radius:50%; width:50px; height:50px; cursor:pointer; margin-bottom:15px; box-shadow:0 3px 0 #cc6600;">üîä</button>
            </div>

            <div id="train-interaction"></div>
            <div id="train-feedback" class="feedback"></div>

            <div id="controls-standard">
                <button id="btn-check" class="btn">Skontrolova≈•</button>
                <button id="btn-next" class="btn hidden" style="background:green;">ƒéalej ‚û°</button>
            </div>

            <div id="controls-test" class="hidden" style="margin-top:20px; display:flex; justify-content:space-between;">
                <button id="btn-test-prev" class="btn btn-nav" style="background:#666;">‚¨Ö Sp√§≈•</button>
                <button id="btn-test-next" class="btn btn-nav">ƒéalej ‚û°</button>
                <button id="btn-test-finish" class="btn hidden" style="background:#dc2626;">üìù Vyhodnoti≈• test</button>
            </div>
        </div>
    </div>

    <div id="screen-vocab-drill" class="container hidden">
        <button id="btn-quit-vocab" class="btn-outline">‚¨Ö Sp√§≈• na slovn√≠k</button>
        <div class="card" style="text-align:center; margin-top:20px;">
            <div style="color:#888; font-size:12px; text-transform:uppercase; letter-spacing:1px;">Prelo≈æ slovo</div>
            <h1 id="drill-word" style="margin:10px 0; color:#2563eb; font-size:2.5em;">...</h1>
            <input type="text" id="drill-input" placeholder="Nap√≠≈° preklad sem...">
            <div id="drill-feedback" class="feedback"></div>
            <button id="drill-check" class="btn">Skontrolova≈•</button>
            <button id="drill-next" class="btn hidden" style="background:green;">ƒéal≈°ie slovo</button>
        </div>
    </div>

    <div id="modal-grammar" class="hidden modal-overlay">
        <div class="modal-content">
            <h3 id="grammar-modal-title">Gramatika</h3>
            <div id="grammar-modal-body" style="font-size:15px; line-height:1.6; color:#444;">Naƒç√≠tavam...</div>
            <button id="btn-close-grammar" class="btn-outline" style="margin-top:25px; width:100%;">Zavrie≈•</button>
        </div>
    </div>


    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDjXlW6hXeDxbFcIiSU4rAvGE3weh8uOig",
            authDomain: "mojjazykovytrener.firebaseapp.com",
            projectId: "mojjazykovytrener",
            storageBucket: "mojjazykovytrener.firebasestorage.app",
            messagingSenderId: "901887815588",
            appId: "1:901887815588:web:bb73239181ff3d5d619b31"
        };

        // Glob√°lne premenn√© pre Firebase, aby ich videl aj zvy≈°ok aplik√°cie
        window.fbDb = null;
        window.fbAuth = null;
        window.currentUser = null;

        document.addEventListener("DOMContentLoaded", () => {
            const logBox = document.getElementById('login-log');
            try {
                firebase.initializeApp(firebaseConfig);
                window.fbDb = firebase.firestore();
                window.fbAuth = firebase.auth();
                const provider = new firebase.auth.GoogleAuthProvider();

                // EVENT LISTENER PRE TLAƒåIDLO PRIHL√ÅSI≈§ (Najbezpeƒçnej≈°ia met√≥da)
                document.getElementById('btn-login-google').addEventListener('click', () => {
                    logBox.innerText = "Otv√°ram Google prihl√°senie...";
                    window.fbAuth.signInWithPopup(provider).catch(e => {
                        logBox.innerText = "Chyba prihl√°senia: " + e.message;
                    });
                });

                // EVENT LISTENER PRE ODHL√ÅSENIE
                document.getElementById('btn-logout').addEventListener('click', () => {
                    window.fbAuth.signOut().then(() => location.reload());
                });

                // SLEDOVANIE STAVU PRIHL√ÅSENIA
                window.fbAuth.onAuthStateChanged(user => {
                    if (user) {
                        window.currentUser = user;
                        document.getElementById('screen-login').classList.add('hidden');
                        document.getElementById('screen-dashboard').classList.remove('hidden');
                        
                        // Ak existuje funkcia na spustenie aplik√°cie, zavolaj ju
                        if (typeof window.initApplication === "function") {
                            window.initApplication();
                        }
                    }
                });
            } catch (error) {
                logBox.innerText = "Kritick√° chyba inicializ√°cie: " + error.message;
            }
        });
    </script>
    <script>
        let userProfile = null;
        let state = {
            currentLevel: null, currentLesson: null, 
            activeChapterData: null, activeQueue: [], activeRound: 1, 
            testIndex: 0, testAnswers: [], testTimer: null, testTimeLeft: 0,
            drillQueue: [], currentDrillWord: null, drillDir: null
        };
        let currentQuestionEn = "";

        // T√ÅTO FUNKCIA SA ZAVOL√Å AUTOMATICKY PO √öSPE≈†NOM PRIHL√ÅSEN√ç (Z BLOKU VY≈†≈†IE)
        window.initApplication = async function() {
            bindEvents();
            await loadProfile();
        };

        // --- BINDING EVENTOV (Nahr√°dza inline onclick) ---
        function bindEvents() {
            // Dashboard Navig√°cia
            document.getElementById('tab-btn-lessons').addEventListener('click', () => switchTab('lessons'));
            document.getElementById('tab-btn-vocab').addEventListener('click', () => switchTab('vocab'));
            document.getElementById('tab-btn-leaderboard').addEventListener('click', () => switchTab('leaderboard'));
            document.getElementById('btn-change-nick').addEventListener('click', changeNick);
            
            // Lekcie Navig√°cia
            document.getElementById('btn-back-levels').addEventListener('click', showLevels);
            document.getElementById('btn-back-lessons').addEventListener('click', showLessons);
            
            // Slovn√≠k
            document.getElementById('btn-voc-learning').addEventListener('click', () => toggleVocabList('learning'));
            document.getElementById('btn-voc-learned').addEventListener('click', () => toggleVocabList('learned'));
            document.getElementById('btn-start-vocab').addEventListener('click', startVocabDrill);
            
            // Tr√©ning a Test 
            document.getElementById('btn-quit-training').addEventListener('click', quitTraining);
            document.getElementById('btn-speak').addEventListener('click', () => speakCurrent(currentQuestionEn));
            document.getElementById('btn-check').addEventListener('click', checkAnswer);
            document.getElementById('btn-next').addEventListener('click', nextItem);
            
            document.getElementById('btn-test-prev').addEventListener('click', () => testNav(-1));
            document.getElementById('btn-test-next').addEventListener('click', () => testNav(1));
            document.getElementById('btn-test-finish').addEventListener('click', evaluateTest);
            
            // Gramatika
            document.getElementById('btn-close-grammar').addEventListener('click', () => document.getElementById('modal-grammar').classList.add('hidden'));

            // Vocab Drill okno
            document.getElementById('btn-quit-vocab').addEventListener('click', stopVocabDrill);
            document.getElementById('drill-check').addEventListener('click', checkVocab);
            document.getElementById('drill-next').addEventListener('click', nextVocab);
            document.getElementById('drill-input').addEventListener('keypress', (e) => { if(e.key==='Enter') checkVocab(); });
        }

        // --- PROFIL ---
        async function loadProfile() {
            const ref = window.fbDb.collection("users").doc(window.currentUser.uid);
            const snap = await ref.get();
            const today = new Date().toISOString().split('T')[0];

            if(snap.exists) {
                userProfile = snap.data();
                if(isNaN(userProfile.points)) userProfile.points = 0;
                if(!userProfile.vocab) userProfile.vocab = {};
                if(!userProfile.completedChapters) userProfile.completedChapters = [];
                
                if(userProfile.lastActive !== today) {
                    const days = Math.ceil(Math.abs(new Date(today) - new Date(userProfile.lastActive))/(1000*3600*24));
                    if(days > 1) {
                        userProfile.points = Math.max(0, userProfile.points - 2);
                        alert("Zame≈°kal si uƒçenie! Odpoƒç√≠tavame 2 body.");
                    }
                    userProfile.dailyTime = 0;
                    userProfile.lastActive = today;
                    await ref.update({ points: userProfile.points, dailyTime: 0, lastActive: today });
                }
            } else {
                userProfile = { points: 0, dailyTime: 0, lastActive: today, nickname: window.currentUser.displayName || "User", completedChapters: [], vocab: {} };
                await ref.set(userProfile);
            }
            updateUI();
            startTimer();
        }

        function updateUI() {
            document.getElementById('user-nick').innerText = userProfile.nickname;
            document.getElementById('disp-points').innerText = userProfile.points.toFixed(1);
            document.getElementById('disp-time').innerText = userProfile.dailyTime + "m";
            
            let mastered = 0;
            Object.values(userProfile.vocab || {}).forEach(i => { if(i.scoreEn>=3 && i.scoreSk>=3) mastered++; });
            document.getElementById('disp-vocab').innerText = mastered;

            renderLevels();
        }

        function changeNick() {
            let n = prompt("Nov√° prez√Ωvka:", userProfile.nickname);
            if(n && n.trim()!=="") { 
                userProfile.nickname = n.trim(); 
                window.fbDb.collection("users").doc(window.currentUser.uid).update({nickname: n.trim()}); 
                updateUI(); 
            }
        }

        // --- NAVIG√ÅCIA Z√ÅLO≈ΩIEK ---
        function switchTab(t) {
            ['lessons','vocab','leaderboard'].forEach(x => {
                document.getElementById('view-'+x).classList.add('hidden');
                document.getElementById('tab-btn-'+x).classList.remove('active');
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-btn-'+t).classList.add('active');
            if(t==='vocab') renderVocabLists();
            if(t==='leaderboard') loadLeaderboard();
        }

        // --- V√ùBER LEKCI√ç ---
        function renderLevels() {
            const lvls = ["A1","A2","B1","B2","C1","C2"];
            const g = document.getElementById('grid-levels'); g.innerHTML="";
            lvls.forEach(l => {
                let d = document.createElement('div'); d.className="item-card"; d.innerHTML=`<h3 style="margin:0;">${l}</h3>`;
                d.style.cursor = "pointer";
                d.addEventListener('click', () => selectLevel(l)); 
                g.appendChild(d);
            });
        }

        function selectLevel(