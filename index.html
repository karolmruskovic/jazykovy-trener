<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Master (v13.0)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size:16px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 2px solid #ddd; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: #555; }
        
        /* Navigation & Tabs */
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .nav-btn { flex: 1; padding: 12px; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .nav-btn.active { background: #2563eb; color: white; }

        /* Grid System */
        .grid-lessons { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .item-card { background: white; border: 2px solid #eee; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .item-card:hover { border-color: #2563eb; transform: translateY(-2px); }
        .item-card.locked { background: #f9fafb; color: #aaa; pointer-events: none; border-color: #eee; }
        .item-card.completed { background: #ecfdf5; border-color: #10b981; color: #065f46; }

        /* Training UI */
        .word-btn { background: #eff6ff; padding: 10px 15px; margin: 5px; border: 1px solid #bfdbfe; border-radius: 20px; cursor: pointer; display: inline-block; color: #2563eb; user-select: none; }
        .word-btn.used { opacity: 0.3; pointer-events: none; }
        input[type="text"] { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; margin-top: 10px; box-sizing: border-box; }
        .feedback { text-align: center; font-weight: bold; margin: 15px 0; min-height: 25px; font-size: 1.1em; }
        .timer { font-size: 1.5em; font-weight: bold; color: orange; text-align: center; margin-bottom: 10px; }
        
        /* Stats */
        .stats-bar { display: flex; justify-content: space-between; background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 1.2em; font-weight: bold; color: #2563eb; }
        .stat-label { font-size: 0.8em; color: #666; }
    </style>
</head>
<body>

    <div id="screen-login" class="container" style="text-align: center; margin-top: 100px;">
        <h1 style="color: #2563eb;">üá¨üáß English Master</h1>
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <p>Prihl√°s sa a pokraƒçuj v uƒçen√≠</p>
            <button onclick="app.login()" class="btn">Prihl√°si≈• sa cez Google</button>
            <div id="login-error" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div id="screen-dashboard" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="font-weight:bold; display:flex; align-items:center; gap:10px;">
                <div style="background:#2563eb; color:white; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center;">üë§</div>
                <span id="user-nick">...</span>
                <button onclick="app.changeNick()" style="border:none; bg:none; cursor:pointer;">‚úèÔ∏è</button>
            </div>
            <button onclick="app.logout()" class="btn-outline" style="color:red; border-color:red;">Odhl√°si≈•</button>
        </div>

        <div class="stats-bar">
            <div class="stat-item"><div class="stat-val" id="disp-points">0</div><div class="stat-label">Body</div></div>
            <div class="stat-item"><div class="stat-val" id="disp-time">0m</div><div class="stat-label">Dnes</div></div>
            <div class="stat-item"><div class="stat-val" id="disp-vocab">0</div><div class="stat-label">Slov√≠ƒçka</div></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-btn active" onclick="app.switchTab('lessons')" id="tab-btn-lessons">Lekcie</button>
            <button class="nav-btn" onclick="app.switchTab('vocab')" id="tab-btn-vocab">Slovn√≠k</button>
            <button class="nav-btn" onclick="app.switchTab('leaderboard')" id="tab-btn-leaderboard">Rebr√≠ƒçek</button>
        </div>

        <div id="view-lessons">
            <div id="level-select" class="card">
                <h3>Vyber √∫rove≈à:</h3>
                <div class="grid-lessons" id="grid-levels"></div>
            </div>

            <div id="lesson-select" class="card hidden">
                <button onclick="app.showLevels()" class="btn-outline">‚¨Ö Sp√§≈• na √∫rovne</button>
                <h3 id="current-level-title">√örove≈à ...</h3>
                <div class="grid-lessons" id="grid-lessons-list"></div>
            </div>

            <div id="chapter-select" class="card hidden">
                <button onclick="app.showLessons()" class="btn-outline">‚¨Ö Sp√§≈• na lekcie</button>
                <h3 id="current-lesson-title">Lekcia ...</h3>
                <div class="grid-lessons" id="grid-chapters"></div>
            </div>
        </div>

        <div id="view-vocab" class="hidden">
            <div class="card" style="text-align:center;">
                <h3>Slovn√≠k (+0.1b za slovo)</h3>
                <p>Mus√≠≈° uhadn√∫≈• slovo 3x EN->SK a 3x SK->EN.</p>
                <button onclick="app.startVocabDrill()" class="btn" style="background:orange;">‚ö° Spusti≈• sk√∫≈°anie</button>
            </div>
            <div id="vocab-stats" class="card"></div>
        </div>

        <div id="view-leaderboard" class="hidden">
            <div class="card" id="leaderboard-list">Naƒç√≠tavam...</div>
        </div>
    </div>

    <div id="screen-training" class="container hidden">
        <button onclick="app.quitTraining()" class="btn-outline">‚ùå Ukonƒçi≈•</button>
        
        <div class="card">
            <div style="display:flex; justify-content:space-between; color:#666; font-size:12px; margin-bottom:10px;">
                <span id="train-info-id">...</span>
                <span id="train-info-round">...</span>
            </div>

            <div id="train-grammar" style="background:#fff9db; padding:15px; border-left:5px solid orange; margin-bottom:20px; display:none;"></div>

            <div id="train-timer" class="timer hidden">06:00</div>

            <div style="text-align:center;">
                <h2 id="train-question">...</h2>
                <button onclick="app.speak()" id="btn-speak" style="font-size:24px; border:none; background:orange; border-radius:50%; width:50px; height:50px; cursor:pointer; margin-bottom:15px;">üîä</button>
            </div>

            <div id="train-interaction"></div>

            <div id="train-feedback" class="feedback"></div>

            <button onclick="app.check()" id="btn-check" class="btn">Skontrolova≈•</button>
            <button onclick="app.nextItem()" id="btn-next" class="btn hidden" style="background:green;">ƒéalej ‚û°</button>
        </div>
    </div>

    <div id="screen-vocab-drill" class="container hidden">
        <button onclick="app.stopVocabDrill()" class="btn-outline">‚ùå Ukonƒçi≈• slovn√≠k</button>
        <div class="card" style="text-align:center; margin-top:20px;">
            <div style="font-size:12px; color:#888; margin-bottom:5px;">Prelo≈æ slovo:</div>
            <h1 id="drill-word" style="margin:0 0 20px 0;">...</h1>
            
            <input type="text" id="drill-input" placeholder="Tvoj preklad..." onkeypress="if(event.key==='Enter') app.checkVocab()">
            <div id="drill-feedback" class="feedback"></div>
            
            <button onclick="app.checkVocab()" class="btn" id="drill-check-btn">Skontrolova≈•</button>
            <button onclick="app.nextVocab()" class="btn hidden" id="drill-next-btn" style="background:green;">ƒéal≈°ie slovo</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDjXlW6hXeDxbFcIiSU4rAvGE3weh8uOig",
            authDomain: "mojjazykovytrener.firebaseapp.com",
            projectId: "mojjazykovytrener",
            storageBucket: "mojjazykovytrener.firebasestorage.app",
            messagingSenderId: "901887815588",
            appId: "1:901887815588:web:bb73239181ff3d5d619b31"
        };

        const app = {
            db: null, auth: null, 
            user: null, profile: null,
            
            // Runtime State
            currentLevel: null,
            currentLesson: null,
            activeChapterData: null,
            activeQueue: [],
            activeRound: 1, // 1=Build, 2=Type, 3=Dictation, 4=Test
            testTimer: null,
            testTimeLeft: 360,

            init: function() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    app.db = firebase.firestore();
                    app.auth = firebase.auth();
                    
                    app.auth.onAuthStateChanged(u => {
                        if(u) {
                            app.user = u;
                            document.getElementById('screen-login').classList.add('hidden');
                            document.getElementById('screen-dashboard').classList.remove('hidden');
                            app.loadProfile();
                        }
                    });
                } catch(e) { alert("Chyba init: "+e.message); }
            },

            login: function() {
                const p = new firebase.auth.GoogleAuthProvider();
                app.auth.signInWithPopup(p).catch(e => alert(e.message));
            },
            logout: function() { app.auth.signOut().then(()=>location.reload()); },

            // --- PROFILE & LOGIC ---
            loadProfile: async function() {
                const ref = app.db.collection("users").doc(app.user.uid);
                const snap = await ref.get();
                const today = new Date().toISOString().split('T')[0];

                if(snap.exists) {
                    app.profile = snap.data();
                    
                    // Inactivity Penalty Check
                    if(app.profile.lastActive !== today) {
                        const lastDate = new Date(app.profile.lastActive);
                        const currDate = new Date(today);
                        const diffTime = Math.abs(currDate - lastDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        if(diffDays > 1) {
                            const penalty = 2; // Fixed 2 points for missing *any* study
                            app.profile.points = Math.max(0, app.profile.points - penalty);
                            alert(`Zame≈°kal si uƒçenie! Str√°ca≈° ${penalty} body.`);
                        }
                        app.profile.dailyTime = 0;
                        app.profile.lastActive = today;
                        await ref.update({ points: app.profile.points, dailyTime:0, lastActive: today });
                    }
                } else {
                    app.profile = {
                        points: 0, dailyTime: 0, lastActive: today,
                        nickname: app.user.displayName || "User",
                        // Progress Structure: { "A1-L01-C01": true } means completed
                        completedChapters: [],
                        vocab: {} // { "word": { sk:"...", scoreEn:0, scoreSk:0 } }
                    };
                    await ref.set(app.profile);
                }
                app.updateUI();
                app.startActivityTimer();
            },

            updateUI: function() {
                document.getElementById('user-nick').innerText = app.profile.nickname;
                document.getElementById('disp-points').innerText = app.profile.points.toFixed(1);
                document.getElementById('disp-time').innerText = app.profile.dailyTime + "m";
                
                // Count vocab words
                const vCount = Object.keys(app.profile.vocab || {}).length;
                document.getElementById('disp-vocab').innerText = vCount;

                app.renderLevels();
            },

            changeNick: function() {
                const n = prompt("Nov√° prez√Ωvka:", app.profile.nickname);
                if(n) {
                    app.profile.nickname = n;
                    app.db.collection("users").doc(app.user.uid).update({nickname:n});
                    app.updateUI();
                }
            },

            startActivityTimer: function() {
                setInterval(() => {
                    if(!document.hidden && app.profile) {
                        app.profile.dailyTime++;
                        document.getElementById('disp-time').innerText = app.profile.dailyTime + "m";
                        app.db.collection("users").doc(app.user.uid).update({dailyTime: app.profile.dailyTime});
                    }
                }, 60000);
            },

            // --- NAVIGATION HIERARCHY ---
            switchTab: function(t) {
                ['lessons','vocab','leaderboard'].forEach(id => {
                    document.getElementById('view-'+id).classList.add('hidden');
                    document.getElementById('tab-btn-'+id).classList.remove('active');
                });
                document.getElementById('view-'+t).classList.remove('hidden');
                document.getElementById('tab-btn-'+t).classList.add('active');
                
                if(t==='lessons') app.renderLevels();
                if(t==='vocab') app.renderVocabStats();
                if(t==='leaderboard') app.loadLeaderboard();
            },

            renderLevels: function() {
                // Levels A1-C2
                const lvls = ["A1","A2","B1","B2","C1","C2"];
                const grid = document.getElementById('grid-levels');
                grid.innerHTML = "";
                
                // Check unlocked levels (Simplified logic: previous level done? For now open A1, restrict others)
                // Better: Just assume A1 open. A2 opens if all A1 chapters done?
                // For simplicity now: Open all levels to browse, lock lessons.
                
                lvls.forEach(l => {
                    const div = document.createElement('div');
                    div.className = "item-card"; // Logic for locking levels can be added here
                    div.innerText = "√örove≈à " + l;
                    div.onclick = () => app.selectLevel(l);
                    grid.appendChild(div);
                });
                
                document.getElementById('level-select').classList.remove('hidden');
                document.getElementById('lesson-select').classList.add('hidden');
                document.getElementById('chapter-select').classList.add('hidden');
            },

            selectLevel: function(lvl) {
                app.currentLevel = lvl;
                document.getElementById('level-select').classList.add('hidden');
                document.getElementById('lesson-select').classList.remove('hidden');
                document.getElementById('current-level-title').innerText = "√örove≈à " + lvl;
                
                const grid = document.getElementById('grid-lessons-list');
                grid.innerHTML = "";
                
                for(let i=1; i<=10; i++) {
                    let num = i<10?'0'+i:i;
                    const div = document.createElement('div');
                    div.className = "item-card";
                    div.innerText = "Lekcia " + i;
                    
                    // Logic: Is previous lesson done? (Complex check omitted for brevity, keeping it simple)
                    // We will lock Chapters instead.
                    div.onclick = () => app.selectLesson(num);
                    grid.appendChild(div);
                }
            },

            showLevels: function() {
                document.getElementById('lesson-select').classList.add('hidden');
                document.getElementById('level-select').classList.remove('hidden');
            },

            selectLesson: function(lessonNum) {
                app.currentLesson = lessonNum;
                document.getElementById('lesson-select').classList.add('hidden');
                document.getElementById('chapter-select').classList.remove('hidden');
                document.getElementById('current-lesson-title').innerText = `${app.currentLevel} - Lekcia ${lessonNum}`;
                
                const grid = document.getElementById('grid-chapters');
                grid.innerHTML = "Naƒç√≠tavam...";
                
                // We need to check which chapters exist and are unlocked
                // ID Format: "A1-L01-C01"
                
                grid.innerHTML = "";
                for(let i=1; i<=10; i++) {
                    let cNum = i<10?'0'+i:i;
                    let id = `${app.currentLevel}-L${app.currentLesson}-C${cNum}`;
                    let prevId = i===1 ? null : `${app.currentLevel}-L${app.currentLesson}-C${(i-1)<10?'0'+(i-1):(i-1)}`;
                    
                    // Check completed
                    let isDone = app.profile.completedChapters.includes(id);
                    // Check locked (First is open. Others require prev done)
                    let isLocked = (prevId && !app.profile.completedChapters.includes(prevId));
                    // Allow jumping if dev/admin? No, stick to rules.
                    
                    const div = document.createElement('div');
                    div.className = `item-card ${isDone?'completed':(isLocked?'locked':'')}`;
                    div.innerHTML = `Kapitola ${i} <br> ${isDone?'‚úÖ':(isLocked?'üîí':'üîì')}`;
                    if(!isLocked) div.onclick = () => app.startChapter(id);
                    grid.appendChild(div);
                }
            },

            showLessons: function() {
                document.getElementById('chapter-select').classList.add('hidden');
                document.getElementById('lesson-select').classList.remove('hidden');
            },

            // --- TRAINING ENGINE ---
            startChapter: async function(id) {
                // Fetch data
                const doc = await app.db.collection("chapters").doc(id).get();
                if(!doc.exists) { alert("T√°to kapitola e≈°te nem√° d√°ta (Admin mus√≠ nahra≈•)."); return; }
                
                app.activeChapterData = doc.data();
                app.activeChapterData.id = id;
                
                // Add Vocab to Profile immediately
                if(app.activeChapterData.vocab) {
                    let changed = false;
                    app.activeChapterData.vocab.forEach(v => {
                        // v = {en: "word", sk: "slovo"}
                        if(!app.profile.vocab[v.en]) {
                            app.profile.vocab[v.en] = { sk: v.sk, scoreEn: 0, scoreSk: 0 };
                            changed = true;
                        }
                    });
                    if(changed) app.db.collection("users").doc(app.user.uid).update({vocab: app.profile.vocab});
                }

                // Setup Round 1
                app.activeRound = 1;
                app.activeQueue = [...app.activeChapterData.sentences]; // [ {en, sk}, ... ]
                
                document.getElementById('screen-dashboard').classList.add('hidden');
                document.getElementById('screen-training').classList.remove('hidden');
                
                app.renderRound();
            },

            quitTraining: function() {
                if(confirm("Naozaj ukonƒçi≈•?")) {
                    clearInterval(app.testTimer);
                    document.getElementById('screen-training').classList.add('hidden');
                    document.getElementById('screen-dashboard').classList.remove('hidden');
                    app.updateUI();
                }
            },

            renderRound: function() {
                const s = app.activeQueue[0];
                const area = document.getElementById('train-interaction');
                const fb = document.getElementById('train-feedback');
                const nextBtn = document.getElementById('btn-next');
                const checkBtn = document.getElementById('btn-check');
                
                area.innerHTML = "";
                fb.innerText = "";
                fb.className = "feedback";
                nextBtn.classList.add('hidden');
                checkBtn.classList.remove('hidden');
                checkBtn.disabled = false;
                document.getElementById('train-timer').classList.add('hidden');

                if(!s) {
                    app.finishRound();
                    return;
                }

                // Info Header
                let roundName = "";
                if(app.activeRound===1) roundName = "1. Kolo: Skladanie";
                if(app.activeRound===2) roundName = "2. Kolo: Preklad";
                if(app.activeRound===3) roundName = "3. Kolo: Dikt√°t";
                if(app.activeRound===4) roundName = "TEST (6 min√∫t)";
                document.getElementById('train-info-round').innerText = roundName;
                document.getElementById('train-info-id').innerText = app.activeChapterData.id;

                // Grammar Display (Only in Round 1, first item)
                const grammarBox = document.getElementById('train-grammar');
                if(app.activeRound === 1 && app.activeQueue.length === app.activeChapterData.sentences.length) {
                    grammarBox.style.display = 'block';
                    grammarBox.innerHTML = `<h3>Gramatika</h3><p>${app.activeChapterData.grammar_detail || app.activeChapterData.grammar}</p>`;
                } else {
                    grammarBox.style.display = 'none';
                }

                // Setup Question
                const qText = document.getElementById('train-question');
                const spkBtn = document.getElementById('btn-speak');
                
                if(app.activeRound === 3) { // Dictation
                    qText.innerText = "üéß Poƒç√∫vaj a nap√≠≈° (EN)";
                    spkBtn.style.display = "inline-block";
                    setTimeout(() => app.speak(s.en), 500);
                } else if(app.activeRound === 4) { // Test (Random mix)
                   qText.innerText = s.sk; // Test is Translate SK->EN
                   spkBtn.style.display = "none";
                } else {
                   qText.innerText = s.sk;
                   spkBtn.style.display = "none";
                }

                // Interaction UI
                if(app.activeRound === 1) {
                    // Builder
                    let box = document.createElement('div');
                    box.id = "build-box";
                    box.style.cssText = "border-bottom: 2px solid #333; min-height:40px; margin-bottom:15px; font-size:1.2em; font-weight:bold;";
                    area.appendChild(box);
                    
                    let words = s.en.replace(/[.,?!]/g,"").split(" ");
                    words.sort(() => Math.random() - 0.5);
                    words.forEach(w => {
                        let btn = document.createElement('button');
                        btn.className = "word-btn";
                        btn.innerText = w;
                        btn.onclick = () => { box.innerText += (box.innerText?" ":"") + w; btn.classList.add('used'); };
                        area.appendChild(btn);
                    });
                    
                    let reset = document.createElement('button');
                    reset.innerText = "‚Ü∫ Reset";
                    reset.className = "btn-outline";
                    reset.style.marginTop = "10px";
                    reset.onclick = app.renderRound;
                    area.appendChild(reset);

                } else {
                    // Input
                    let inp = document.createElement('input');
                    inp.type = "text";
                    inp.id = "user-inp";
                    inp.placeholder = "Nap√≠≈° po anglicky...";
                    inp.autocomplete = "off";
                    inp.onkeypress = (e) => { if(e.key==="Enter") app.check(); };
                    area.appendChild(inp);
                    setTimeout(()=>inp.focus(), 100);
                }
            },

            check: function() {
                const s = app.activeQueue[0];
                let val = "";
                
                if(app.activeRound === 1) val = document.getElementById('build-box').innerText;
                else val = document.getElementById('user-inp').value;

                // Normalize
                let v = val.trim().toLowerCase().replace(/[.,?!]/g,"").replace(/\s+/g," ");
                let c = s.en.trim().toLowerCase().replace(/[.,?!]/g,"").replace(/\s+/g," ");
                
                const fb = document.getElementById('train-feedback');
                const checkBtn = document.getElementById('btn-check');
                const nextBtn = document.getElementById('btn-next');

                if(v === c) {
                    fb.innerText = "‚úÖ Spr√°vne!";
                    fb.style.color = "green";
                    checkBtn.classList.add('hidden');
                    nextBtn.classList.remove('hidden');
                    if(app.activeRound === 4) app.finishRound(); // In test, instant next? No, wait for user.
                    else if(app.activeRound !== 4) app.speak(s.en);
                } else {
                    fb.innerText = `‚ùå Chyba! Spr√°vne: "${s.en}"`;
                    fb.style.color = "red";
                    app.speak(s.en);
                    // If Test -> FAIL immediately
                    if(app.activeRound === 4) {
                        alert("Chyba v teste! Test ukonƒçen√Ω. Sk√∫s znova.");
                        clearInterval(app.testTimer);
                        app.startChapter(app.activeChapterData.id); // Restart chapter? Or just test? Let's restart chapter for drill.
                    } else {
                        // Normal round -> Push back to queue
                        app.activeQueue.push(s);
                        checkBtn.classList.add('hidden');
                        nextBtn.classList.remove('hidden');
                    }
                }
            },

            nextItem: function() {
                app.activeQueue.shift();
                app.renderRound();
            },

            finishRound: function() {
                if(app.activeRound < 3) {
                    alert(`Kolo ${app.activeRound} hotov√©! Ide sa ƒèalej.`);
                    app.activeRound++;
                    app.activeQueue = [...app.activeChapterData.sentences];
                    app.renderRound();
                } else if (app.activeRound === 3) {
                    // Start Test
                    alert("Gratulujem! Teraz nasleduje TEST. 6 viet, 6 min√∫t. ≈Ωiadna chyba nie je povolen√°.");
                    app.activeRound = 4;
                    // Pick 6 random
                    let all = [...app.activeChapterData.sentences];
                    all.sort(()=>Math.random()-0.5);
                    app.activeQueue = all.slice(0, 6);
                    
                    document.getElementById('train-timer').classList.remove('hidden');
                    app.testTimeLeft = 360;
                    app.updateTimerDisplay();
                    app.testTimer = setInterval(() => {
                        app.testTimeLeft--;
                        app.updateTimerDisplay();
                        if(app.testTimeLeft <= 0) {
                            clearInterval(app.testTimer);
                            alert("ƒåas vypr≈°al! Test ne√∫spe≈°n√Ω.");
                            app.startChapter(app.activeChapterData.id);
                        }
                    }, 1000);
                    
                    app.renderRound();
                } else {
                    // Test Done
                    clearInterval(app.testTimer);
                    app.completeChapter();
                }
            },

            updateTimerDisplay: function() {
                let m = Math.floor(app.testTimeLeft / 60);
                let s = app.testTimeLeft % 60;
                document.getElementById('train-timer').innerText = `${m}:${s<10?'0'+s:s}`;
            },

            completeChapter: async function() {
                // Scoring
                // Chapter done (+1), Test done (+2) = Total +3 for this flow.
                // If it completes a Lesson (10 chapters) -> +10
                // If Level -> +20
                
                let points = 3; 
                app.profile.points += points;
                
                // Save progress
                if(!app.profile.completedChapters.includes(app.activeChapterData.id)) {
                    app.profile.completedChapters.push(app.activeChapterData.id);
                }
                
                // Check Lesson Completion (Simply check if all 10 exist in completed)
                // ID: "A1-L01-C.."
                let [lvl, les] = app.activeChapterData.id.split('-L'); // "A1", "01-C01"
                les = les.split('-')[0]; // "01"
                
                let completedInLesson = app.profile.completedChapters.filter(c => c.startsWith(`${lvl}-L${les}`)).length;
                if(completedInLesson === 10) {
                    alert("üéâ Dokonƒçil si cel√∫ LEKCIU! +10 bodov");
                    app.profile.points += 10;
                    
                    // Check Level Completion
                    // Assuming 10 lessons per level
                    // This logic can be complex, let's keep it simple for now.
                }

                await app.db.collection("users").doc(app.user.uid).update({
                    points: app.profile.points,
                    completedChapters: app.profile.completedChapters
                });
                
                alert(`Kapitola hotov√°! +${points} body.`);
                document.getElementById('screen-training').classList.add('hidden');
                document.getElementById('screen-dashboard').classList.remove('hidden');
                app.selectLesson(app.currentLesson); // Refresh list
                app.updateUI();
            },

            speak: function(text) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = "en-US";
                speechSynthesis.speak(u);
            },

            // --- VOCAB DRILL ---
            renderVocabStats: function() {
                const v = app.profile.vocab || {};
                const total = Object.keys(v).length;
                let mastered = 0;
                // Count mastered (scoreEn >= 3 AND scoreSk >= 3)
                Object.values(v).forEach(i => { if(i.scoreEn>=3 && i.scoreSk>=3) mastered++; });
                
                let html = `<p>Celkom slov: ${total} | Nauƒçen√©: ${mastered}</p>`;
                document.getElementById('vocab-stats').innerHTML = html;
            },

            startVocabDrill: function() {
                // Filter unmastered words
                app.drillQueue = [];
                const v = app.profile.vocab || {};
                
                Object.keys(v).forEach(en => {
                    const item = v[en];
                    if(item.scoreEn < 3 || item.scoreSk < 3) {
                        app.drillQueue.push({ en: en, sk: item.sk, data: item });
                    }
                });

                if(app.drillQueue.length === 0) { alert("V≈°etky slov√≠ƒçka m√°≈° nauƒçen√©! Skvel√° pr√°ca."); return; }

                document.getElementById('view-vocab').classList.add('hidden');
                document.getElementById('screen-vocab-drill').classList.remove('hidden');
                app.nextVocab();
            },

            stopVocabDrill: function() {
                document.getElementById('screen-vocab-drill').classList.add('hidden');
                document.getElementById('view-vocab').classList.remove('hidden');
                app.updateUI();
            },

            nextVocab: function() {
                // Random word from queue
                if(app.drillQueue.length === 0) { app.stopVocabDrill(); return; }
                const idx = Math.floor(Math.random() * app.drillQueue.length);
                app.currentDrillWord = app.drillQueue[idx];
                
                // Random direction (based on needs)
                // If scoreEn < 3 and scoreSk < 3, random.
                // Else pick the one needed.
                let d = app.currentDrillWord.data;
                if(d.scoreEn < 3 && d.scoreSk < 3) app.drillDir = Math.random()>0.5 ? 'en_sk' : 'sk_en';
                else if(d.scoreEn < 3) app.drillDir = 'sk_en'; // Show SK, ask EN
                else app.drillDir = 'en_sk'; // Show EN, ask SK
                
                const label = document.getElementById('drill-word');
                const inp = document.getElementById('drill-input');
                const fb = document.getElementById('drill-feedback');
                
                inp.value = "";
                fb.innerText = "";
                document.getElementById('drill-check-btn').classList.remove('hidden');
                document.getElementById('drill-next-btn').classList.add('hidden');

                if(app.drillDir === 'en_sk') {
                    label.innerText = app.currentDrillWord.en; // Translate to SK
                    inp.placeholder = "Preklad do slovenƒçiny...";
                } else {
                    label.innerText = app.currentDrillWord.sk; // Translate to EN
                    inp.placeholder = "Preklad do angliƒçtiny...";
                }
                inp.focus();
            },

            checkVocab: function() {
                const val = document.getElementById('drill-input').value.trim().toLowerCase();
                const w = app.currentDrillWord;
                let correct = false;
                let answer = "";

                if(app.drillDir === 'en_sk') {
                    correct = (val === w.sk.toLowerCase());
                    answer = w.sk;
                } else {
                    correct = (val === w.en.toLowerCase());
                    answer = w.en;
                }

                const fb = document.getElementById('drill-feedback');
                if(correct) {
                    fb.innerText = "‚úÖ Spr√°vne!";
                    fb.style.color = "green";
                    
                    // Update Score
                    if(app.drillDir === 'en_sk') w.data.scoreSk++;
                    else w.data.scoreEn++;
                    
                    // Points +0.1
                    app.profile.points += 0.1;
                    
                    // Save
                    app.db.collection("users").doc(app.user.uid).update({
                        vocab: app.profile.vocab,
                        points: app.profile.points
                    });

                    // Check if mastered
                    if(w.data.scoreEn >= 3 && w.data.scoreSk >= 3) {
                        alert("üåü Slovo nauƒçen√©! (" + w.en + ")");
                        // Remove from queue
                        app.drillQueue = app.drillQueue.filter(i => i.en !== w.en);
                    }

                    document.getElementById('drill-check-btn').classList.add('hidden');
                    document.getElementById('drill-next-btn').classList.remove('hidden');
                } else {
                    fb.innerText = `‚ùå Chyba. Spr√°vne: ${answer}`;
                    fb.style.color = "red";
                }
            },

            loadLeaderboard: function() {
                const l = document.getElementById('leaderboard-list'); l.innerText = "Naƒç√≠tavam...";
                app.db.collection("users").orderBy("points","desc").limit(10).get().then(s => {
                    l.innerHTML = ""; let i=1;
                    s.forEach(d => {
                        let u=d.data();
                        l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                            <span>#${i++} <b>${u.nickname}</b></span> <span>${u.points.toFixed(1)}b</span>
                        </div>`;
                    });
                });
            }
        };

        app.init();
    </script>
</body>
</html>