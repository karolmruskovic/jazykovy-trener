<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Master (v16.0 - Auto Fix)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .btn { background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size:16px; transition: 0.2s;}
        .btn:hover { background: #1d4ed8; }
        .btn-outline { background: transparent; border: 2px solid #ddd; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: #555; }
        .btn-nav { width: 48%; display: inline-block; }
        .btn-sm { padding: 6px 12px; font-size: 13px; width: auto; margin-top: 5px; border-radius: 6px;}

        /* Progress Bars */
        .progress-container { background: #eee; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; position: relative; }
        .progress-fill { background: #2563eb; height: 100%; width: 0%; transition: 0.3s; }
        .timer-fill { background: orange; height: 100%; width: 100%; transition: 1s linear; }

        /* Training UI */
        .word-btn { background: #eff6ff; padding: 10px 15px; margin: 5px; border: 1px solid #bfdbfe; border-radius: 20px; cursor: pointer; display: inline-block; color: #2563eb; user-select: none; }
        .word-btn.used { opacity: 0.3; pointer-events: none; }
        input[type="text"] { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; margin-top: 10px; box-sizing: border-box; outline:none; }
        input[type="text"]:focus { border-color:#2563eb; }
        .feedback { text-align: center; font-weight: bold; margin: 15px 0; min-height: 25px; font-size: 1.1em; }
        
        /* Test Results */
        .result-row { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .res-correct { color: green; }
        .res-wrong { color: red; }
        .res-answer { font-weight: bold; display: block; margin-top: 3px; color:#555;}

        /* Modal Overlay */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; text-align: left; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top:0; color:#2563eb;}

        /* Nav & Grid */
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .nav-btn { flex: 1; padding: 12px; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666;}
        .nav-btn.active { background: #2563eb; color: white; }
        .grid-lessons { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .item-card { background: white; border: 2px solid #eee; padding: 15px 5px; text-align: center; border-radius: 8px; cursor: default; display:flex; flex-direction:column; justify-content:space-between;}
        .item-card.locked { background: #f9fafb; color: #aaa; border-color: #eee; }
        .item-card.completed { background: #ecfdf5; border-color: #10b981; }
        
        /* Vocab Item */
        .vocab-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .vocab-item.mastered { background: #f0fdf4; border-left: 4px solid #10b981; }

        /* Stats */
        .stats-bar { display: flex; justify-content: space-between; background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .stat-val { font-size: 1.2em; font-weight: bold; color: #2563eb; text-align:center; }
        .stat-lbl { font-size: 0.8em; color: #666; text-align:center; }
    </style>
</head>
<body>

    <div id="screen-login" class="container" style="text-align: center; margin-top: 10vh;">
        <h1 style="color: #2563eb;">üá¨üáß English Master</h1>
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <p>Prihl√°s sa a pokraƒçuj v uƒçen√≠</p>
            <button id="btn-login-google" class="btn">Prihl√°si≈• sa cez Google</button>
            <div id="login-log" style="color: red; margin-top: 15px; font-size: 13px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="screen-dashboard" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="font-weight:bold; font-size:1.1em;">üë§ <span id="user-nick">...</span> <button id="btn-change-nick" style="border:none;background:none;cursor:pointer;font-size:0.9em;">‚úèÔ∏è</button></div>
            <button id="btn-logout" class="btn-outline" style="color:red; border-color:red; padding:6px 12px;">Odhl√°si≈•</button>
        </div>

        <div class="stats-bar">
            <div><div class="stat-val" id="disp-points">0</div><div class="stat-lbl">Body</div></div>
            <div><div class="stat-val" id="disp-time">0m</div><div class="stat-lbl">Dnes</div></div>
            <div><div class="stat-val" id="disp-vocab">0</div><div class="stat-lbl">Nauƒçen√©</div></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-btn active" id="tab-btn-lessons">Lekcie</button>
            <button class="nav-btn" id="tab-btn-vocab">Slovn√≠k</button>
            <button class="nav-btn" id="tab-btn-leaderboard">Rebr√≠ƒçek</button>
        </div>

        <div id="view-lessons">
            <div id="level-select" class="card">
                <h3>Vyber √∫rove≈à:</h3>
                <div class="grid-lessons" id="grid-levels"></div>
            </div>
            <div id="lesson-select" class="card hidden">
                <button id="btn-back-levels" class="btn-outline" style="margin-bottom:15px;">‚¨Ö Sp√§≈• na √∫rovne</button>
                <h3 id="current-level-title" style="margin-top:0;">...</h3>
                <div class="grid-lessons" id="grid-lessons-list"></div>
            </div>
            <div id="chapter-select" class="card hidden">
                <button id="btn-back-lessons" class="btn-outline" style="margin-bottom:15px;">‚¨Ö Sp√§≈• na lekcie</button>
                <h3 id="current-lesson-title" style="margin-top:0;">...</h3>
                <div class="grid-lessons" id="grid-chapters"></div>
            </div>
        </div>

        <div id="view-vocab" class="hidden">
            <div class="card" style="text-align:center;">
                <h3 style="margin-top:0;">Inteligentn√Ω Slovn√≠k</h3>
                <p style="font-size:14px; color:#555;">Slovo sa oznaƒç√≠ ako "Nauƒçen√©" a≈æ keƒè ho zodpovie≈° 3x spr√°vne do angliƒçtiny a 3x do slovenƒçiny.</p>
                <button id="btn-start-vocab" class="btn" style="background:orange;">‚ö° Tr√©nova≈• slov√≠ƒçka</button>
            </div>
            
            <div class="nav-tabs" style="margin-bottom: 10px;">
                <button class="nav-btn active" id="btn-voc-learning">Uƒç√≠m sa (0)</button>
                <button class="nav-btn" id="btn-voc-learned">Nauƒçen√© (0)</button>
            </div>
            
            <div id="vocab-list-learning" class="card"></div>
            <div id="vocab-list-learned" class="card hidden"></div>
        </div>

        <div id="view-leaderboard" class="hidden">
            <div class="card" id="leaderboard-list">Naƒç√≠tavam...</div>
        </div>
    </div>

    <div id="screen-training" class="container hidden">
        <button id="btn-quit-training" class="btn-outline">‚ùå Ukonƒçi≈•</button>
        
        <div class="card">
            <div style="display:flex; justify-content:space-between; color:#666; font-size:12px; margin-bottom:5px;">
                <span id="train-info-round" style="font-weight:bold; color:#2563eb;">...</span>
                <span id="train-counter">0/10</span>
            </div>

            <div class="progress-container" id="bar-progress-container">
                <div id="bar-progress" class="progress-fill"></div>
            </div>
            <div class="progress-container hidden" id="bar-timer-container" style="background:#ddd;">
                <div id="bar-timer" class="timer-fill"></div>
            </div>

            <div id="train-grammar" style="background:#fff9db; padding:15px; border-left:5px solid orange; margin-bottom:20px; display:none; font-size:14px;"></div>

            <div style="text-align:center;">
                <h2 id="train-question">...</h2>
                <button id="btn-speak" style="font-size:24px; border:none; background:orange; border-radius:50%; width:50px; height:50px; cursor:pointer; margin-bottom:15px; box-shadow:0 3px 0 #cc6600;">üîä</button>
            </div>

            <div id="train-interaction"></div>
            <div id="train-feedback" class="feedback"></div>

            <div id="controls-standard">
                <button id="btn-check" class="btn">Skontrolova≈•</button>
                <button id="btn-next" class="btn hidden" style="background:green;">ƒéalej ‚û°</button>
            </div>

            <div id="controls-test" class="hidden" style="margin-top:20px; display:flex; justify-content:space-between;">
                <button id="btn-test-prev" class="btn btn-nav" style="background:#666;">‚¨Ö Sp√§≈•</button>
                <button id="btn-test-next" class="btn btn-nav">ƒéalej ‚û°</button>
                <button id="btn-test-finish" class="btn hidden" style="background:#dc2626;">üìù Vyhodnoti≈• test</button>
            </div>
        </div>
    </div>

    <div id="screen-vocab-drill" class="container hidden">
        <button id="btn-quit-vocab" class="btn-outline">‚¨Ö Sp√§≈• na slovn√≠k</button>
        <div class="card" style="text-align:center; margin-top:20px;">
            <div style="color:#888; font-size:12px; text-transform:uppercase; letter-spacing:1px;">Prelo≈æ slovo</div>
            <h1 id="drill-word" style="margin:10px 0; color:#2563eb; font-size:2.5em;">...</h1>
            <input type="text" id="drill-input" placeholder="Nap√≠≈° preklad sem...">
            <div id="drill-feedback" class="feedback"></div>
            <button id="drill-check" class="btn">Skontrolova≈•</button>
            <button id="drill-next" class="btn hidden" style="background:green;">ƒéal≈°ie slovo</button>
        </div>
    </div>

    <div id="modal-grammar" class="hidden modal-overlay">
        <div class="modal-content">
            <h3 id="grammar-modal-title">Gramatika</h3>
            <div id="grammar-modal-body" style="font-size:15px; line-height:1.6; color:#444;">Naƒç√≠tavam...</div>
            <button id="btn-close-grammar" class="btn-outline" style="margin-top:25px; width:100%;">Zavrie≈•</button>
        </div>
    </div>


    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDjXlW6hXeDxbFcIiSU4rAvGE3weh8uOig",
            authDomain: "mojjazykovytrener.firebaseapp.com",
            projectId: "mojjazykovytrener",
            storageBucket: "mojjazykovytrener.firebasestorage.app",
            messagingSenderId: "901887815588",
            appId: "1:901887815588:web:bb73239181ff3d5d619b31"
        };

        window.fbDb = null;
        window.fbAuth = null;
        window.currentUser = null;

        document.addEventListener("DOMContentLoaded", () => {
            const logBox = document.getElementById('login-log');
            try {
                firebase.initializeApp(firebaseConfig);
                window.fbDb = firebase.firestore();
                window.fbAuth = firebase.auth();
                const provider = new firebase.auth.GoogleAuthProvider();

                document.getElementById('btn-login-google').addEventListener('click', () => {
                    logBox.innerText = "Otv√°ram Google prihl√°senie...";
                    window.fbAuth.signInWithPopup(provider).catch(e => {
                        logBox.innerText = "Chyba prihl√°senia: " + e.message;
                    });
                });

                document.getElementById('btn-logout').addEventListener('click', () => {
                    window.fbAuth.signOut().then(() => location.reload());
                });

                window.fbAuth.onAuthStateChanged(user => {
                    if (user) {
                        window.currentUser = user;
                        document.getElementById('screen-login').classList.add('hidden');
                        document.getElementById('screen-dashboard').classList.remove('hidden');
                        
                        if (typeof window.initApplication === "function") {
                            window.initApplication();
                        }
                    }
                });
            } catch (error) {
                logBox.innerText = "Kritick√° chyba inicializ√°cie: " + error.message;
            }
        });
    </script>
    <script>
        let userProfile = null;
        let state = {
            currentLevel: null, currentLesson: null, 
            activeChapterData: null, activeQueue: [], activeRound: 1, 
            testIndex: 0, testAnswers: [], testTimer: null, testTimeLeft: 0,
            drillQueue: [], currentDrillWord: null, drillDir: null
        };
        let currentQuestionEn = "";

        window.initApplication = async function() {
            bindEvents();
            await loadProfile();
        };

        function bindEvents() {
            document.getElementById('tab-btn-lessons').addEventListener('click', () => switchTab('lessons'));
            document.getElementById('tab-btn-vocab').addEventListener('click', () => switchTab('vocab'));
            document.getElementById('tab-btn-leaderboard').addEventListener('click', () => switchTab('leaderboard'));
            document.getElementById('btn-change-nick').addEventListener('click', changeNick);
            
            document.getElementById('btn-back-levels').addEventListener('click', showLevels);
            document.getElementById('btn-back-lessons').addEventListener('click', showLessons);
            
            document.getElementById('btn-voc-learning').addEventListener('click', () => toggleVocabList('learning'));
            document.getElementById('btn-voc-learned').addEventListener('click', () => toggleVocabList('learned'));
            document.getElementById('btn-start-vocab').addEventListener('click', startVocabDrill);
            
            document.getElementById('btn-quit-training').addEventListener('click', quitTraining);
            document.getElementById('btn-speak').addEventListener('click', () => speakCurrent(currentQuestionEn));
            document.getElementById('btn-check').addEventListener('click', checkAnswer);
            document.getElementById('btn-next').addEventListener('click', nextItem);
            
            document.getElementById('btn-test-prev').addEventListener('click', () => testNav(-1));
            document.getElementById('btn-test-next').addEventListener('click', () => testNav(1));
            document.getElementById('btn-test-finish').addEventListener('click', evaluateTest);
            
            document.getElementById('btn-close-grammar').addEventListener('click', () => document.getElementById('modal-grammar').classList.add('hidden'));

            document.getElementById('btn-quit-vocab').addEventListener('click', stopVocabDrill);
            document.getElementById('drill-check').addEventListener('click', checkVocab);
            document.getElementById('drill-next').addEventListener('click', nextVocab);
            document.getElementById('drill-input').addEventListener('keypress', (e) => { if(e.key==='Enter') checkVocab(); });
        }

        // --- SILN√Å OPRAVA PROFILU ---
        async function loadProfile() {
            const ref = window.fbDb.collection("users").doc(window.currentUser.uid);
            const snap = await ref.get();
            const today = new Date().toISOString().split('T')[0];

            if(snap.exists) {
                userProfile = snap.data();
                let needsUpdate = false;

                // Bezpeƒçnostn√° kontrola ka≈æd√©ho poƒæa (ochrana pred undefined chybou)
                if (userProfile.points === undefined || isNaN(Number(userProfile.points))) { userProfile.points = 0; needsUpdate = true; }
                else { userProfile.points = Number(userProfile.points); }

                if (userProfile.dailyTime === undefined || isNaN(Number(userProfile.dailyTime))) { userProfile.dailyTime = 0; needsUpdate = true; }
                else { userProfile.dailyTime = Number(userProfile.dailyTime); }

                if (!userProfile.vocab) { userProfile.vocab = {}; needsUpdate = true; }
                if (!Array.isArray(userProfile.completedChapters)) { userProfile.completedChapters = []; needsUpdate = true; }
                if (!userProfile.nickname) { userProfile.nickname = window.currentUser.displayName || "≈†tudent"; needsUpdate = true; }

                if(userProfile.lastActive !== today) {
                    if(userProfile.lastActive) {
                        const days = Math.ceil(Math.abs(new Date(today) - new Date(userProfile.lastActive))/(1000*3600*24));
                        if(days > 1) {
                            userProfile.points = Math.max(0, userProfile.points - 2);
                            alert("Zame≈°kal si uƒçenie! Str√°ca≈° 2 body.");
                        }
                    }
                    userProfile.dailyTime = 0;
                    userProfile.lastActive = today;
                    needsUpdate = true;
                }

                if(needsUpdate) {
                    try { await ref.set(userProfile, {merge: true}); } 
                    catch(e) { console.error("Chyba opravy profilu: ", e); }
                }

            } else {
                userProfile = { points: 0, dailyTime: 0, lastActive: today, nickname: window.currentUser.displayName || "≈†tudent", completedChapters: [], vocab: {} };
                await ref.set(userProfile);
            }
            updateUI();
            startTimer();
        }

        function updateUI() {
            document.getElementById('user-nick').innerText = userProfile.nickname || "≈†tudent";
            document.getElementById('disp-points').innerText = Number(userProfile.points).toFixed(1);
            document.getElementById('disp-time').innerText = Number(userProfile.dailyTime) + "m";
            
            let mastered = 0;
            Object.values(userProfile.vocab || {}).forEach(i => { if(i.scoreEn>=3 && i.scoreSk>=3) mastered++; });
            document.getElementById('disp-vocab').innerText = mastered;

            renderLevels();
        }

        function changeNick() {
            let n = prompt("Nov√° prez√Ωvka:", userProfile.nickname);
            if(n && n.trim()!=="") { 
                userProfile.nickname = n.trim(); 
                window.fbDb.collection("users").doc(window.currentUser.uid).update({nickname: n.trim()}); 
                updateUI(); 
            }
        }

        function switchTab(t) {
            ['lessons','vocab','leaderboard'].forEach(x => {
                document.getElementById('view-'+x).classList.add('hidden');
                document.getElementById('tab-btn-'+x).classList.remove('active');
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-btn-'+t).classList.add('active');
            if(t==='vocab') renderVocabLists();
            if(t==='leaderboard') loadLeaderboard();
        }

        function renderLevels() {
            const lvls = ["A1","A2","B1","B2","C1","C2"];
            const g = document.getElementById('grid-levels'); 
            if(!g) return;
            g.innerHTML="";
            lvls.forEach(l => {
                let d = document.createElement('div'); d.className="item-card"; d.innerHTML=`<h3 style="margin:0;">${l}</h3>`;
                d.style.cursor = "pointer";
                d.addEventListener('click', () => selectLevel(l)); 
                g.appendChild(d);
            });
        }

        function selectLevel(l) {
            state.currentLevel = l;
            document.getElementById('level-select').classList.add('hidden');
            document.getElementById('lesson-select').classList.remove('hidden');
            document.getElementById('current-level-title').innerText = "√örove≈à "+l;
            const g = document.getElementById('grid-lessons-list'); g.innerHTML="";
            for(let i=1; i<=10; i++) {
                let n = i<10?'0'+i:i;
                let d = document.createElement('div'); d.className="item-card"; d.innerHTML=`<b>Lekcia ${i}</b>`;
                d.style.cursor = "pointer";
                d.addEventListener('click', () => selectLesson(n)); 
                g.appendChild(d);
            }
        }

        function showLevels() { document.getElementById('lesson-select').classList.add('hidden'); document.getElementById('level-select').classList.remove('hidden'); }
        
        function selectLesson(n) {
            state.currentLesson = n;
            document.getElementById('lesson-select').classList.add('hidden');
            document.getElementById('chapter-select').classList.remove('hidden');
            document.getElementById('current-lesson-title').innerText = `${state.currentLevel} - Lekcia ${n}`;
            const g = document.getElementById('grid-chapters'); g.innerHTML="Naƒç√≠tavam...";
            
            g.innerHTML="";
            for(let i=1; i<=10; i++) {
                let cNum = i<10?'0'+i:i;
                let id = `${state.currentLevel}-L${state.currentLesson}-C${cNum}`;
                let isDone = userProfile.completedChapters.includes(id);
                let prevId = i===1 ? null : `${state.currentLevel}-L${state.currentLesson}-C${(i-1)<10?'0'+(i-1):(i-1)}`;
                let locked = prevId && !userProfile.completedChapters.includes(prevId);

                let d = document.createElement('div');
                d.className = `item-card ${isDone?'completed':(locked?'locked':'')}`;
                d.innerHTML = `<div style="font-weight:bold; margin-bottom:5px;">Kapitola ${i}</div><div style="font-size:1.5em; margin-bottom:10px;">${isDone?'‚úÖ':(locked?'üîí':'üîì')}</div>`;

                if(!locked) {
                    let btnBox = document.createElement('div');
                    let bPlay = document.createElement('button');
                    bPlay.className = "btn btn-sm"; bPlay.innerText = "‚ñ∂ Spusti≈•";
                    bPlay.addEventListener('click', (e) => { e.stopPropagation(); startChapter(id); });

                    let bGram = document.createElement('button');
                    bGram.className = "btn-outline btn-sm"; bGram.innerText = "üìò Gramatika"; bGram.style.width = "100%";
                    bGram.addEventListener('click', (e) => { e.stopPropagation(); showGrammar(id); });

                    btnBox.appendChild(bPlay); btnBox.appendChild(bGram);
                    d.appendChild(btnBox);
                }
                g.appendChild(d);
            }
        }
        function showLessons() { document.getElementById('chapter-select').classList.add('hidden'); document.getElementById('lesson-select').classList.remove('hidden'); }

        async function showGrammar(id) {
            document.getElementById('grammar-modal-title').innerText = "Naƒç√≠tavam...";
            document.getElementById('grammar-modal-body').innerHTML = "‚è≥ Pros√≠m ƒçakaj...";
            document.getElementById('modal-grammar').classList.remove('hidden');

            try {
                const doc = await window.fbDb.collection("chapters").doc(id).get();
                if(doc.exists) {
                    let data = doc.data();
                    document.getElementById('grammar-modal-title').innerText = `Gramatika: ${id}`;
                    document.getElementById('grammar-modal-body').innerHTML = data.grammar_detail || data.grammar || "Bez detailu.";
                } else {
                    document.getElementById('grammar-modal-body').innerHTML = "K tejto kapitole zatiaƒæ nebola nahrat√° gramatika.";
                }
            } catch(e) { document.getElementById('grammar-modal-body').innerHTML = "Chyba: " + e.message; }
        }

        async function startChapter(id) {
            const doc = await window.fbDb.collection("chapters").doc(id).get();
            if(!doc.exists) return alert("Kapitola zatiaƒæ nebola nahran√°.");
            
            state.activeChapterData = doc.data();
            state.activeChapterData.id = id;
            state.activeRound = 1;
            state.activeQueue = [...state.activeChapterData.sentences];
            
            if(state.activeChapterData.vocab) {
                let changed = false;
                state.activeChapterData.vocab.forEach(v => {
                    if(!userProfile.vocab[v.en]) { userProfile.vocab[v.en]={sk:v.sk, scoreEn:0, scoreSk:0}; changed=true; }
                });
                if(changed) window.fbDb.collection("users").doc(window.currentUser.uid).update({vocab: userProfile.vocab});
            }

            document.getElementById('screen-dashboard').classList.add('hidden');
            document.getElementById('screen-training').classList.remove('hidden');
            renderRound();
        }

        function quitTraining() {
            if(confirm("Naozaj chce≈° ukonƒçi≈• lekciu? Postup sa neulo≈æ√≠.")) {
                clearInterval(state.testTimer);
                document.getElementById('screen-training').classList.add('hidden');
                document.getElementById('screen-dashboard').classList.remove('hidden');
            }
        }

        function renderRound() {
            const s = state.activeQueue[0];
            const area = document.getElementById('train-interaction');
            const fb = document.getElementById('train-feedback');
            
            area.innerHTML=""; fb.innerText="";
            document.getElementById('controls-standard').classList.remove('hidden');
            document.getElementById('controls-test').classList.add('hidden');
            document.getElementById('bar-timer-container').classList.add('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('btn-check').classList.remove('hidden');

            let total = state.activeChapterData.sentences.length;
            let current = total - state.activeQueue.length;
            document.getElementById('bar-progress').style.width = ((current/total)*100) + "%";
            document.getElementById('train-counter').innerText = `${current}/${total}`;

            let titles = ["1. Kolo: Skladanie", "2. Kolo: Preklad", "3. Kolo: Dikt√°t"];
            document.getElementById('train-info-round').innerText = titles[state.activeRound-1];
            document.getElementById('train-grammar').style.display = 'none';

            if(!s) { finishRound(); return; }

            currentQuestionEn = s.en;
            const qt = document.getElementById('train-question');
            const sb = document.getElementById('btn-speak');
            sb.style.display='none';

            if(state.activeRound===3) {
                qt.innerText="üéß Poƒç√∫vaj a nap√≠≈° (EN)";
                sb.style.display='inline-block';
                setTimeout(()=>speakCurrent(s.en), 500);
            } else {
                qt.innerText = s.sk;
            }

            if(state.activeRound===1) {
                let box = document.createElement('div'); box.id="build-box"; box.style.cssText="border-bottom:2px solid #ccc; min-height:40px; margin-bottom:15px; font-weight:bold; font-size:1.2em; padding-bottom:5px;";
                area.appendChild(box);
                let w = s.en.replace(/[.,?!]/g,"").split(" "); w.push("not"); w.sort(()=>Math.random()-0.5);
                w.forEach(wd => {
                    let b = document.createElement('button'); b.className="word-btn"; b.innerText=wd;
                    b.addEventListener('click', () => { box.innerText+=(box.innerText?" ":"")+wd; b.classList.add('used'); });
                    area.appendChild(b);
                });
                let r = document.createElement('button'); r.innerText="‚Ü∫ Zmaza≈• v≈°etko"; r.className="btn-outline btn-sm"; r.style.marginTop="10px"; 
                r.addEventListener('click', renderRound); 
                area.appendChild(r);
            } else {
                let i = document.createElement('input'); i.type="text"; i.id="user-inp"; i.placeholder="Nap√≠≈° preklad..."; 
                i.autocomplete="off"; 
                i.addEventListener('keypress', (e) => { if(e.key==="Enter") checkAnswer(); });
                area.appendChild(i); setTimeout(()=>i.focus(),100);
            }
        }

        function checkAnswer() {
            const s = state.activeQueue[0];
            let val = state.activeRound===1 ? document.getElementById('build-box').innerText : document.getElementById('user-inp').value;
            let v = val.trim().toLowerCase().replace(/[.,?!]/g,"").replace(/\s+/g," ");
            let c = s.en.trim().toLowerCase().replace(/[.,?!]/g,"").replace(/\s+/g," ");
            const fb = document.getElementById('train-feedback');

            if(v===c) {
                fb.innerText="‚úÖ V√Ωborne!"; fb.style.color="green";
                document.getElementById('btn-check').classList.add('hidden');
                document.getElementById('btn-next').classList.remove('hidden');
                speakCurrent(s.en);
            } else {
                fb.innerText=`‚ùå Chyba! M√° by≈•: "${s.en}"`; fb.style.color="red";
                speakCurrent(s.en);
                state.activeQueue.push(s); 
                document.getElementById('btn-check').classList.add('hidden');
                document.getElementById('btn-next').classList.remove('hidden');
            }
        }

        function nextItem() {
            state.activeQueue.shift();
            renderRound();
        }

        function finishRound() {
            if(state.activeRound < 3) {
                alert(`Kolo ${state.activeRound} hotov√©!`);
                state.activeRound++;
                state.activeQueue = [...state.activeChapterData.sentences];
                renderRound();
            } else if(state.activeRound === 3) {
                startTestRound();
            }
        }

        function startTestRound() {
            alert("Nasleduje Z√ÅVEREƒåN√ù TEST.\nM√°≈° 6 min√∫t na preklad 6 n√°hodn√Ωch viet.");
            state.activeRound = 4;
            document.getElementById('train-info-round').innerText = "Z√ÅVEREƒåN√ù TEST";
            
            let all = [...state.activeChapterData.sentences];
            all.sort(()=>Math.random()-0.5);
            state.activeQueue = all.slice(0, 6);
            
            state.testIndex = 0;
            state.testAnswers = ["", "", "", "", "", ""];
            state.testTimeLeft = 360; 
            
            document.getElementById('bar-timer-container').classList.remove('hidden');
            state.testTimer = setInterval(() => {
                state.testTimeLeft--;
                document.getElementById('bar-timer').style.width = ((state.testTimeLeft / 360) * 100) + "%";
                if(state.testTimeLeft <= 0) evaluateTest(); 
            }, 1000);

            renderTestItem();
        }

        function renderTestItem() {
            const area = document.getElementById('train-interaction');
            area.innerHTML = "";
            document.getElementById('train-feedback').innerText = "";
            document.getElementById('btn-speak').style.display = 'none';
            
            document.getElementById('controls-standard').classList.add('hidden');
            document.getElementById('controls-test').classList.remove('hidden');

            document.getElementById('bar-progress').style.width = ((state.testIndex / 6) * 100) + "%";
            document.getElementById('train-counter').innerText = `Veta ${state.testIndex + 1} zo 6`;

            const s = state.activeQueue[state.testIndex];
            document.getElementById('train-question').innerText = s.sk;

            let inp = document.createElement('input'); 
            inp.type = "text"; inp.id = "test-inp"; 
            inp.value = state.testAnswers[state.testIndex]; 
            inp.placeholder = "Tvoj preklad..."; inp.autocomplete = "off";
            
            inp.addEventListener('input', (e) => { state.testAnswers[state.testIndex] = e.target.value; });
            inp.addEventListener('keypress', (e) => { if(e.key==="Enter") { if(state.testIndex<5) testNav(1); else evaluateTest(); } });
            
            area.appendChild(inp); setTimeout(()=>inp.focus(), 100);

            document.getElementById('btn-test-next').classList.toggle('hidden', state.testIndex === 5);
            document.getElementById('btn-test-finish').classList.toggle('hidden', state.testIndex !== 5);
        }

        function testNav(dir) {
            const inp = document.getElementById('test-inp');
            if(inp) state.testAnswers[state.testIndex] = inp.value;

            let newIdx = state.testIndex + dir;
            if(newIdx >= 0 && newIdx < 6) { state.testIndex = newIdx; renderTestItem(); }
        }

        async function evaluateTest() {
            clearInterval(state.testTimer);
            const inp = document.getElementById('test-inp');
            if(inp && state.testIndex === 5) state.testAnswers[5] = inp.value;

            let correctCount = 0;
            let html = "<h3 style='border-bottom:2px solid #eee; padding-bottom:10px;'>Vyhodnotenie Testu</h3>";
            
            for(let i=0; i<6; i++) {
                let userAns = state.testAnswers[i].trim().toLowerCase().replace(/[.,?!]/g,"").replace(/\s+/g," ");
                let correctAns = state.activeQueue[i].en.trim().toLowerCase().replace(/[.,?!]/g,"").replace(/\s+/g," ");
                let isOk = (userAns === correctAns);
                if(isOk) correctCount++;

                html += `<div class="result-row">
                    <div style="color:#666; font-size:0.9em;">${state.activeQueue[i].sk}</div>
                    <div class="${isOk ? 'res-correct' : 'res-wrong'}">
                        ${isOk ? '‚úÖ' : '‚ùå'} <b>Tvoje:</b> ${state.testAnswers[i] || '<i>≈æiadna odpoveƒè</i>'}
                    </div>
                    ${!isOk ? `<div class="res-answer">üëâ Spr√°vne: ${state.activeQueue[i].en}</div>` : ''}
                </div>`;
            }

            const area = document.getElementById('train-interaction');
            area.innerHTML = html;
            document.getElementById('controls-test').classList.add('hidden');
            document.getElementById('train-question').innerText = `V√Ωsledok: ${correctCount}/6`;
            document.getElementById('bar-progress').style.width = "100%";

            if(correctCount === 6) {
                let pts = 3; 
                if(!userProfile.completedChapters.includes(state.activeChapterData.id)) {
                    userProfile.completedChapters.push(state.activeChapterData.id);
                }
                
                let [lvl, les] = state.activeChapterData.id.split('-L');
                les = les.split('-')[0];
                let doneInLesson = userProfile.completedChapters.filter(c => c.startsWith(`${lvl}-L${les}`)).length;
                if(doneInLesson === 10) pts += 10;

                userProfile.points += pts;
                await window.fbDb.collection("users").doc(window.currentUser.uid).update({
                    points: userProfile.points, completedChapters: userProfile.completedChapters
                });

                let btn = document.createElement('button'); btn.className = "btn"; btn.innerText = "N√°vrat do menu";
                btn.addEventListener('click', () => {
                    document.getElementById('screen-training').classList.add('hidden');
                    document.getElementById('screen-dashboard').classList.remove('hidden');
                    selectLesson(state.currentLesson); updateUI();
                });
                area.appendChild(btn);
            } else {
                let btn = document.createElement('button'); btn.className = "btn"; btn.style.background = "#dc2626";
                btn.innerText = "Opakova≈• Dikt√°t a Test";
                btn.addEventListener('click', () => {
                    state.activeRound = 3; 
                    state.activeQueue = [...state.activeChapterData.sentences];
                    renderRound();
                });
                area.appendChild(btn);
            }
        }

        function toggleVocabList(type) {
            document.getElementById('btn-voc-learning').classList.remove('active');
            document.getElementById('btn-voc-learned').classList.remove('active');
            document.getElementById('vocab-list-learning').classList.add('hidden');
            document.getElementById('vocab-list-learned').classList.add('hidden');
            
            document.getElementById('btn-voc-'+type).classList.add('active');
            document.getElementById('vocab-list-'+type).classList.remove('hidden');
        }

        function renderVocabLists() {
            const listLearning = document.getElementById('vocab-list-learning');
            const listLearned = document.getElementById('vocab-list-learned');
            listLearning.innerHTML = ""; listLearned.innerHTML = "";
            
            const v = userProfile.vocab || {};
            let countLrn = 0, countDone = 0;

            Object.keys(v).forEach(k => {
                let item = v[k];
                let isMastered = (item.scoreEn >= 3 && item.scoreSk >= 3);
                let html = `<div class="vocab-item ${isMastered?'mastered':''}">
                    <div><b>${k}</b> <span style="color:#666;font-size:0.9em;margin-left:5px;">(${item.sk})</span></div>
                    <div style="font-size:0.8em; font-weight:bold; color:${isMastered?'#10b981':'#888'};">EN: ${item.scoreEn}/3 | SK: ${item.scoreSk}/3</div>
                </div>`;

                if(isMastered) { listLearned.innerHTML += html; countDone++; } 
                else { listLearning.innerHTML += html; countLrn++; }
            });

            if(countLrn === 0) listLearning.innerHTML = "<p style='text-align:center;color:#888;padding:20px;'>V≈°etko zatiaƒæ nauƒçen√©!</p>";
            if(countDone === 0) listLearned.innerHTML = "<p style='text-align:center;color:#888;padding:20px;'>Zatiaƒæ nem√°≈° zvl√°dnut√© ≈æiadne slov√≠ƒçko na 100%.</p>";

            document.getElementById('btn-voc-learning').innerText = `Uƒç√≠m sa (${countLrn})`;
            document.getElementById('btn-voc-learned').innerText = `Nauƒçen√© (${countDone})`;
        }

        function startVocabDrill() {
            state.drillQueue = [];
            const v = userProfile.vocab || {};
            Object.keys(v).forEach(en => {
                let d = v[en];
                if(d.scoreEn<3 || d.scoreSk<3) state.drillQueue.push({en:en, sk:d.sk, data:d});
            });
            if(state.drillQueue.length===0) return alert("V≈°etko nauƒçen√©! Spusti nov√∫ kapitolu pre nov√© slov√°.");
            
            document.getElementById('view-vocab').classList.add('hidden');
            document.getElementById('screen-vocab-drill').classList.remove('hidden');
            nextVocab();
        }

        function nextVocab() {
            if(state.drillQueue.length===0) return stopVocabDrill();
            const idx = Math.floor(Math.random() * state.drillQueue.length);
            state.currentDrillWord = state.drillQueue[idx];
            
            let d = state.currentDrillWord.data;
            state.drillDir = (d.scoreEn<3 && d.scoreSk<3) ? (Math.random()>0.5?'en_sk':'sk_en') : (d.scoreEn<3?'sk_en':'en_sk');
            
            document.getElementById('drill-word').innerText = state.drillDir==='en_sk' ? state.currentDrillWord.en : state.currentDrillWord.sk;
            document.getElementById('drill-input').value = "";
            document.getElementById('drill-feedback').innerText = "";
            document.getElementById('drill-check').classList.remove('hidden');
            document.getElementById('drill-next').classList.add('hidden');
            document.getElementById('drill-input').focus();
        }

        function checkVocab() {
            const val = document.getElementById('drill-input').value.trim().toLowerCase();
            const w = state.currentDrillWord;
            let correct = (state.drillDir==='en_sk') ? (val===w.sk.toLowerCase()) : (val===w.en.toLowerCase());
            
            if(correct) {
                document.getElementById('drill-feedback').innerText = "‚úÖ Spr√°vne!";
                document.getElementById('drill-feedback').style.color = "green";
                if(state.drillDir==='en_sk') w.data.scoreSk++; else w.data.scoreEn++;
                
                userProfile.points += 0.1;
                window.fbDb.collection("users").doc(window.currentUser.uid).update({vocab: userProfile.vocab, points: userProfile.points});
                
                if(w.data.scoreEn>=3 && w.data.scoreSk>=3) {
                    state.drillQueue = state.drillQueue.filter(i => i.en !== w.en);
                }
                document.getElementById('drill-check').classList.add('hidden');
                document.getElementById('drill-next').classList.remove('hidden');
            } else {
                document.getElementById('drill-feedback').innerText = `‚ùå Spr√°vne: ${state.drillDir==='en_sk'?w.sk:w.en}`;
                document.getElementById('drill-feedback').style.color = "red";
            }
        }

        function stopVocabDrill() {
            document.getElementById('screen-vocab-drill').classList.add('hidden');
            document.getElementById('view-vocab').classList.remove('hidden');
            updateUI(); renderVocabLists();
        }

        function loadLeaderboard() {
            const l = document.getElementById('leaderboard-list'); l.innerHTML="Naƒç√≠tavam...";
            window.fbDb.collection("users").orderBy("points","desc").limit(10).get().then(s => {
                l.innerHTML=""; let i=1;
                s.forEach(d => {
                    let u=d.data();
                    l.innerHTML+=`<div style="padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between; align-items:center;">
                        <span style="font-size:1.1em;"><b>#${i++}</b> ${u.nickname}</span>
                        <span style="color:#2563eb; font-weight:bold;">${u.points.toFixed(1)} b</span>
                    </div>`;
                });
            });
        }

        function startTimer() {
            setInterval(() => {
                if(!document.hidden && userProfile) {
                    userProfile.dailyTime++;
                    document.getElementById('disp-time').innerText = userProfile.dailyTime+"m";
                    window.fbDb.collection("users").doc(window.currentUser.uid).update({dailyTime: userProfile.dailyTime});
                }
            }, 60000);
        }

        function speakCurrent(txt) {
            if(!txt) return;
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = "en-GB"; 
            speechSynthesis.speak(u);
        }
    </script>
</body>
</html>